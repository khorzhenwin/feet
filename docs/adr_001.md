# ADR 001: Fees Service Core Design

## Status
Accepted

## Context
We need a fees service that manages bills, supports multi-currency line items, and closes bills automatically after a fee period via Temporal. The API must be safe for retries and align with clear lifecycle semantics.

## Decisions

### Money Representation
- Use **integer minor units** (`int64`) for all amounts to avoid floating point errors.
- Represent currency as a **small enum** (e.g., `USD`, `GEL`).
- Maintain bill totals as a **map of currency → amount_minor** with **no automatic conversion**.

### API Semantics
- `POST /bills` creates a bill and starts the workflow.
  - **Idempotent** via client‑supplied idempotency key or bill ID.
- `POST /bills/:id/line-items` adds a line item only while a bill is `open`.
  - Reject when bill is `closed` or `charged`.
- `POST /bills/:id/close` closes a bill (idempotent).
- `POST /bills/:id/charge` completes the lifecycle and marks as charged (idempotent).
- `GET /bills` supports pagination and date filtering.

### Data Modeling & Lifecycle
- Bill lifecycle: **open → closed → charged**.
- Closing freezes totals; charging marks finalization.
- Totals are stored per currency; no conversion.
- Line items are immutable once written.

### Temporal Usage
Temporal is used to:
- **Enforce time‑based closing** of bills (reliable timers).
- **Retry** closing activities safely with idempotent operations.
- **Accept signals** to cancel the timer when bills close manually.
- Provide **traceability** of the lifecycle.

## Consequences
- Clients must provide idempotency keys for safe retries.
- Multi-currency totals require downstream consumers to handle multiple currencies explicitly.
- Temporal introduces operational dependency but ensures reliability of delayed execution.
